<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Memories ‚Äì Unified API</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --ink:#e5e7eb; --muted:#9ca3af; --accent:#22c55e }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #1f2937;background:#0b1220;position:sticky;top:0;z-index:3}
    header h1{font-size:16px;margin:0;font-weight:600}
    header .env{font-size:12px;color:var(--muted)}
    .env-controls{display:flex;gap:8px;align-items:center}
    main{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:16px;max-width:1500px;margin:0 auto}
    .card{background:var(--panel);border:1px solid #1f2937;border-radius:12px;overflow:hidden}
    .card h3{margin:0;padding:12px 14px;border-bottom:1px solid #1f2937;font-size:13px;color:#cbd5e1}
    .card .body{padding:12px 14px;display:grid;gap:10px}
    label{display:grid;gap:6px;font-size:12px;color:#cbd5e1}
    input[type="text"],input[type="url"],input[type="file"],select,textarea{width:100%;background:#0b1220;color:var(--ink);border:1px solid #1f2937;border-radius:8px;padding:9px 10px;font-size:13px}
    textarea{min-height:120px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{display:inline-flex;align-items:center;gap:8px;background:var(--accent);border:none;color:#052e16;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.secondary{background:#1f2937;color:#e5e7eb}
    .btn.small{padding:4px 8px;font-size:11px}
    .btn.ghost{background:#0b1220;border:1px solid #1f2937;color:#cbd5e1}
    .tabs{display:flex;gap:6px}
    .tab{padding:6px 10px;border-radius:8px;border:1px solid #1f2937;background:#0b1220;color:#fff;cursor:pointer;font-size:14px;font-weight:700}
    .tab.active{background:#1f2937}
    pre,code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px}
    pre{margin:0;white-space:pre-wrap;word-break:break-word;max-height:520px;overflow:auto;background:#0b1220;border-top:1px solid #1f2937;padding:12px 14px}
    .pill{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:999px;font-weight:600;font-size:11px}
    .pill.get{background:#052e16;color:#86efac;border:1px solid #166534}
    .pill.post{background:#111827;color:#93c5fd;border:1px solid #1d4ed8}
    .muted{color:#9ca3af;font-size:12px}
    .divider{height:1px;background:#1f2937;margin:8px 0}
    .hint{font-size:11px;color:#a3a3a3}
    .inline{display:flex;gap:8px;align-items:center}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    kbd{background:#0b1220;border:1px solid #1f2937;border-radius:6px;padding:2px 6px;font-size:11px}
    .file-preview{font-size:12px;color:#cbd5e1;background:#0b1220;border:1px dashed #334155;border-radius:8px;padding:8px;white-space:pre-wrap}
    .preview{margin:0;padding:12px 14px;border-top:1px solid #1f2937}
    .preview .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
    .preview h4{margin:0 0 8px 0;font-size:13px;color:#cbd5e1}
    .preview-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px}
    .preview-item{background:#0b1220;border:1px solid #334155;border-radius:10px;padding:8px;overflow:hidden}
    .preview-item img,.preview-item video{width:100%;height:130px;object-fit:cover;border-radius:8px;display:block;cursor:zoom-in}
    .preview-item audio{width:100%;display:block}
    .preview-item .meta{font-size:11px;color:#9ca3af;margin-top:6px;word-break:break-word}
    .preview-item a{text-decoration:none;color:#93c5fd;font-size:12px}
    .tiny{font-size:11px;color:#9ca3af}
    .doc{max-width:1500px;margin:16px auto}
    .doc details{background:#0b1220;border:1px solid #1f2937;border-radius:10px;padding:8px 10px}
    .doc details+details{margin-top:10px}
    .doc summary{cursor:pointer;font-weight:700;color:#cbd5e1}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px}
    .lightbox{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:50}
    .lightbox.open{display:flex}
    .lightbox__backdrop{position:absolute;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(2px)}
    .lightbox__panel{position:relative;margin:24px;max-width:95vw;max-height:95vh}
    .lightbox__panel img{display:block;max-width:95vw;max-height:90vh;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,.6)}
    .lightbox__close{position:absolute;top:-10px;right:-10px;border-radius:999px;padding:6px 10px;background:#0b1220;border:1px solid #334155;color:#cbd5e1;cursor:pointer}
    .lightbox__cap{margin-top:8px;text-align:center;color:#9ca3af;font-size:12px}
  </style>
</head>
<body>
<header>
  <div class="inline">
    <h1>Memories ‚Äì Unified API</h1>
    <span class="env">Gateway: <code id="gatewayDisplay">http://localhost:8080</code></span>
  </div>
  <div class="env-controls">
    <label class="muted" for="envSelect" style="margin:0 4px 0 0">ENV</label>
    <select id="envSelect" title="–í—ã–±–µ—Ä–∏—Ç–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ">
      <option value="dev">dev</option>
      <option value="stage">stage</option>
      <option value="prod">prod</option>
    </select>

    <!-- –ö–ù–û–ü–ö–ê –û–¢–ö–†–´–¢–ò–Ø –î–ï–ú–û-–§–†–û–ù–¢–ê (–ø–µ—Ä–µ–¥ Quick Login) -->
    <button id="openDemo" class="btn small ghost" title="–û—Ç–∫—Ä—ã—Ç—å –¥–µ–º–æ-—Ñ—Ä–æ–Ω—Ç">
      –û—Ç–∫—Ä—ã—Ç—å Demo Front
    </button>

    <button id="quickLogin" class="btn small" title="–û—Ç–∫—Ä—ã—Ç—å Identity ‚Üí Login –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å">Quick Login</button>

    <div style="width:12px"></div>

    <div class="tabs" id="tabs">
      <button class="tab" data-tab="identity">Identity</button>
      <button class="tab" data-tab="memory">MemoryArchive</button>
      <button class="tab" data-tab="access">AccessControl</button>
      <button class="tab" data-tab="audit">AuditLogging</button>
      <button class="tab" data-tab="notification">Notification</button>
      <button class="tab" data-tab="profile">ProfileService</button>
      <!-- NEW TABS -->
      <button class="tab" data-tab="moderation">Moderation</button>
      <button class="tab" data-tab="publicView">PublicView</button>
      <button class="tab" data-tab="qrcode">QRCode</button>
    </div>
  </div>
</header>

<main>
  <!-- LEFT -->
  <section class="card">
    <h3>–ó–∞–ø—Ä–æ—Å</h3>
    <div class="body" id="reqPane">
      <div class="row">
        <label>–ú–µ—Ç–æ–¥ <select id="method"></select></label>
        <label>Endpoint <select id="endpoint"></select></label>
      </div>

      <label>
        URL (—á–µ—Ä–µ–∑ Gateway)
        <input id="url" type="url" />
        <span id="urlHint" class="hint"></span>
      </label>

      <div class="inline">
        <label style="flex:1">
          Authorization (Bearer)
          <input id="auth" type="text" placeholder="–≤—Å—Ç–∞–≤—å—Ç–µ JWT –±–µ–∑ 'Bearer '" />
        </label>
        <button class="btn small secondary" id="copyJwt" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω">üìã</button>
      </div>
      <span class="hint">JWT —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ localStorage. –î–ª—è –∑–∞—â–∏—â—ë–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ (Memory, Profile, Access, Audit) ‚Äî –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω.</span>

      <label class="inline">
        <input type="checkbox" id="persistBodies" />
        <span class="hint">–°–æ—Ö—Ä–∞–Ω—è—Ç—å —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –º–µ–∂–¥—É —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º–∏</span>
      </label>

      <div id="jsonBlock">
        <label>JSON Body<textarea id="json" spellcheck="false"></textarea></label>
      </div>

      <div id="formBlock" style="display:none;">
        <div class="grid2">
          <label>OwnerId<input id="OwnerId" type="text" placeholder="uuid" /></label>
          <label>Title<input id="Title" type="text" /></label>
          <label>Description<textarea id="Description"></textarea></label>
          <label>
            MediaType
            <select id="MediaType">
              <option>Image</option>
              <option>Video</option>
              <option>Audio</option>
              <option>Document</option>
            </select>
          </label>
          <label>
            AccessLevel
            <select id="AccessLevel">
              <option>Private</option>
              <option>Public</option>
              <option>FriendsOnly</option>
            </select>
          </label>
          <label>Tags (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)<input id="Tags" type="text" placeholder="tag1,tag2" /></label>
          <!-- MULTI -->
          <label>–§–∞–π–ª—ã<input id="File" type="file" multiple /></label>
          <label>FileName (–æ–ø—Ü.)<input id="FileName" type="text" /></label>
        </div>
        <div class="file-preview" id="filePreview">–§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</div>
      </div>

      <div class="row">
        <button class="btn" id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button class="btn secondary" id="fill">–ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–∏–º–µ—Ä</button>
      </div>

      <div class="divider"></div>
      <div class="inline">
        <label style="flex:1">
          –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π curl
          <textarea id="curl" readonly></textarea>
        </label>
        <button class="btn small secondary" id="copyCurl" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å curl">üìã</button>
      </div>
    </div>
  </section>

  <!-- RIGHT -->
  <section class="card">
    <h3>–û—Ç–≤–µ—Ç</h3>
    <div class="body">
      <div class="inline"><span class="muted">HTTP Status:</span><span id="status" class="pill get">‚Äî</span></div>
      <label>–ó–∞–≥–æ–ª–æ–≤–∫–∏<textarea id="respHeaders" readonly></textarea></label>
    </div>
    <h3>–¢–µ–ª–æ –æ—Ç–≤–µ—Ç–∞</h3>
    <pre><code id="resp" class="language-json">‚Äî</code></pre>

    <div id="preview" class="preview" style="display:none;">
      <div class="toolbar" id="previewToolbar" style="display:none;">
        <button class="btn small ghost" id="openAll">–û—Ç–∫—Ä—ã—Ç—å –≤—Å—ë</button>
        <button class="btn small ghost" id="copyIds">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å mediaId</button>
        <button class="btn small ghost" id="downloadAll">–°–∫–∞—á–∞—Ç—å –≤—Å—ë (zip)</button>
        <span class="tiny" id="dlHint" style="display:none;"></span>
      </div>
      <h4>–ú–µ–¥–∏–∞</h4>
      <div class="preview-grid" id="previewGrid"></div>
    </div>
  </section>
</main>

<section class="card doc">
  <h3>–ü–∞–º—è—Ç–∫–∞ –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ ‚Äî —Å–µ—Ä–≤–∏—Å—ã, —ç–∫—à–µ–Ω—ã, –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã</h3>
  <div class="body">
    <details open>
      <summary>ProfileService ‚Äî /profile/api/profile</summary>
<pre class="mono">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è (1:1 c –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º). –¢—Ä–µ–±—É–µ—Ç JWT.

‚Ä¢ CreateProfile ‚Äî –°–û–ó–î–ê–Å–¢ –ø—Ä–æ—Ñ–∏–ª—å.
POST /profile/api/profile
Request:
{
  "userId": "guid",
  "fullName": "string",
  "birthDate": "2025-01-01T00:00:00Z",
  "displayName": "string?",
  "bio": "string?",
  "accessMode": "Anytime | AfterDeath",
  "avatarUrl": "string?"
}
Response 201:
{ "id":"guid", "userId":"guid", "fullName":"...", "birthDate":"ISO", "displayName":"?", "bio":"?", "deathConfirmed":false,
  "accessMode":"AfterDeath", "createdAt":"ISO", "updatedAt":null, "avatarUrl":"?" }

‚Ä¢ GetById ‚Äî –ü–û–õ–£–ß–ò–¢–¨ –ø—Ä–æ—Ñ–∏–ª—å –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É –ø—Ä–æ—Ñ–∏–ª—è.
GET /profile/api/profile/{id}
‚Üí 200 UserProfileDto | 404

‚Ä¢ GetByUserId ‚Äî –ü–û–õ–£–ß–ò–¢–¨ –ø—Ä–æ—Ñ–∏–ª—å –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
GET /profile/api/profile/by-user/{userId}
‚Üí 200 UserProfileDto | 404

‚Ä¢ UpdateProfile ‚Äî –û–ë–ù–û–í–ò–¢–¨ –ø–æ–ª—è –ø—Ä–æ—Ñ–∏–ª—è.
PUT /profile/api/profile/{id}
Request: { "id":"guid", "fullName":"...", "birthDate":"ISO", "displayName":"?", "bio":"?", "accessMode":"Anytime|AfterDeath", "avatarUrl":"?" }
‚Üí 200 UserProfileDto | 404

‚Ä¢ DeleteProfile ‚Äî –£–î–ê–õ–ò–¢–¨ –ø—Ä–æ—Ñ–∏–ª—å.
DELETE /profile/api/profile/{id}
‚Üí 204

‚Ä¢ ConfirmDeath ‚Äî –ü–û–ú–ï–¢–ò–¢–¨ —Å—Ç–∞—Ç—É—Å 'DeathConfirmed'.
POST /profile/api/profile/{userId}/confirm-death
‚Üí 200 { "message": "Death confirmed" }</pre>
    </details>

    <details>
      <summary>Identity ‚Äî /identity</summary>
<pre class="mono">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –≤—ã–¥–∞—á–∞ JWT.

‚Ä¢ Login ‚Äî –ø–æ–ª—É—á–∏—Ç—å accessToken/refreshToken (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–≤—ã–º).
POST /identity/login
{ "username":"...", "password":"..." }
‚Üí 200 { "accessToken":"jwt", "refreshToken":"...", "expiresIn":3600 }

‚Ä¢ Register ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
POST /identity/register
{ "username":"...", "password":"...", "email":"...", "displayName":"..." }
‚Üí 200 { "userId":"guid" }

‚Ä¢ Refresh ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ accessToken –ø–æ refreshToken.
POST /identity/refresh
{ "refreshToken":"..." }
‚Üí 200 { "accessToken":"jwt" }

‚Ä¢ Me ‚Äî –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–∑ —Ç–æ–∫–µ–Ω–∞).
GET /identity/me
‚Üí 200 { "id":"guid", "username":"...", "email":"...", "displayName":"..." }</pre>
    </details>

    <details>
      <summary>MemoryArchive ‚Äî /memory/api</summary>
<pre class="mono">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π –∏ –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö –º–µ–¥–∏–∞.

‚Ä¢ CreateMemory ‚Äî —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å —Å —Ñ–∞–π–ª–æ–º (multipart/form-data).
POST /memory/api/memory
Fields: OwnerId(uuid), Title, Description, MediaType(Image|Video|Audio|Document),
        AccessLevel(Private|Public|FriendsOnly), Tags(repeatable), File(@file, repeatable), FileName(opt)
‚Üí 201 { "id":"guid","ownerId":"guid","title":"...","mediaFiles":[{ "id":"guid","fileName":"...","mediaType":"image/jpeg","url":"..." }, ...] }

‚Ä¢ GetMemoryById ‚Äî –ø–æ–ª—É—á–∏—Ç—å –∑–∞–ø–∏—Å—å.
GET /memory/api/memory/{memoryId}
‚Üí 200 MemoryDto | 404

... (–∏ —Ç.–¥.)</pre>
    </details>

    <div class="hint">
      –î–ª—è –∑–∞—â–∏—â—ë–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ –¥–æ–±–∞–≤–ª—è–π—Ç–µ <code>Authorization: Bearer &lt;jwt&gt;</code>. –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã
      <code>{id}</code>, <code>{userId}</code>, <code>{memoryId}</code>, <code>{mediaId}</code> –ø–æ–¥—Å—Ç–∞–≤–ª—è—é—Ç—Å—è
      –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–µ curl (–ª–µ–≤–∞—è –ø–∞–Ω–µ–ª—å).
    </div>
  </div>
</section>

<section class="card doc">
  <h3>–¢–∏–ø–æ–≤—ã–µ –æ—à–∏–±–∫–∏ –∏ —Ä–µ—à–µ–Ω–∏—è (–∫–æ—Ä–æ—Ç–∫–æ)</h3>
  <div class="body">
    <details open>
      <summary>ProfileService</summary>
<pre class="mono">401 invalid_token ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∫–ª—é—á–µ–π/alg/iss/aud –∏ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ Authorization.
403 forbidden ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª–∏—Ç–∏–∫–∏/—Ä–æ–ª–∏/–≤–ª–∞–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–º.
404 not found ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–Ω userId –≤–º–µ—Å—Ç–æ profileId; –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /by-user.
415 unsupported media type ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ Content-Type.</pre>
    </details>
    <details>
      <summary>Identity</summary>
<pre class="mono">401 ‚Äî –Ω–µ–≤–µ—Ä–Ω—ã–µ –∫—Ä–µ–¥—ã/–ø—Ä–æ—Å—Ä–æ—á–µ–Ω —Ç–æ–∫–µ–Ω.
400 ‚Äî –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (–ø–∞—Ä–æ–ª—å, email).</pre>
    </details>
    <details>
      <summary>MemoryArchive</summary>
<pre class="mono">401 ‚Äî –Ω–µ—Ç JWT/–Ω–µ –ø—Ä–æ–∫–∏–Ω—É–ª–∏; 415 ‚Äî JSON –≤–º–µ—Å—Ç–æ multipart.</pre>
    </details>
  </div>
</section>

<!-- Lightbox container -->
<div id="lightbox" class="lightbox" aria-hidden="true">
  <div class="lightbox__backdrop" data-close="1"></div>
  <figure class="lightbox__panel">
    <button class="btn small ghost lightbox__close" type="button" title="–ó–∞–∫—Ä—ã—Ç—å" data-close="1">‚úï</button>
    <img id="lightboxImg" alt="">
    <figcaption id="lightboxCap" class="lightbox__cap tiny"></figcaption>
  </figure>
</div>

<script>
(() => {
  hljs.highlightAll();

  // UI elements
  const envSelect = document.getElementById('envSelect'),
        gatewayDisplay = document.getElementById('gatewayDisplay'),
        openDemoBtn = document.getElementById('openDemo'),
        quickLoginBtn = document.getElementById('quickLogin'),
        method = document.getElementById('method'),
        endpointSel = document.getElementById('endpoint'),
        url = document.getElementById('url'), urlHint = document.getElementById('urlHint'),
        auth = document.getElementById('auth'), json = document.getElementById('json'),
        jsonBlock = document.getElementById('jsonBlock'), formBlock = document.getElementById('formBlock'),
        fileInput = document.getElementById('File'), filePreview = document.getElementById('filePreview'),
        sendBtn = document.getElementById('send'), fillBtn = document.getElementById('fill'),
        curlBox = document.getElementById('curl'), respEl = document.getElementById('resp'),
        statusEl = document.getElementById('status'), respHeaders = document.getElementById('respHeaders'),
        tabs = document.getElementById('tabs'), persistBodies = document.getElementById('persistBodies'),
        preview = document.getElementById('preview'), previewGrid = document.getElementById('previewGrid'),
        previewToolbar = document.getElementById('previewToolbar'),
        openAllBtn = document.getElementById('openAll'),
        copyIdsBtn = document.getElementById('copyIds'),
        downloadAllBtn = document.getElementById('downloadAll'),
        dlHint = document.getElementById('dlHint');

  /* ==== Lightbox refs ==== */
  const lightbox = document.getElementById('lightbox');
  const lightboxImg = document.getElementById('lightboxImg');
  const lightboxCap = document.getElementById('lightboxCap');

  function openLightbox(src, caption) {
    lightboxImg.src = src || '';
    lightboxImg.alt = caption || '';
    lightboxCap.textContent = caption || '';
    lightbox.classList.add('open');
    lightbox.setAttribute('aria-hidden', 'false');
  }
  function closeLightbox() {
    lightbox.classList.remove('open');
    lightbox.setAttribute('aria-hidden', 'true');
    lightboxImg.src = '';
    lightboxImg.alt = '';
    lightboxCap.textContent = '';
  }
  lightbox.addEventListener('click', (e) => { if (e.target.dataset.close) closeLightbox(); });
  window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && lightbox.classList.contains('open')) closeLightbox(); });

  // environment presets
  const ENV_PRESETS = {
    dev: { name:'dev', gateway:'http://localhost:8080', services: {
      identity:'http://localhost:8080', profile:'http://localhost:8080', memory:'http://localhost:8080',
      access:'http://localhost:8080', audit:'http://localhost:8080', notification:'http://localhost:8080',
      moderation:'http://localhost:8080', publicView:'http://localhost:8080', qrcode:'http://localhost:8080' } },
    stage:{ name:'stage', gateway:'https://stage.api.memories.local', services:{
      identity:'https://stage.api.memories.local', profile:'https://stage.api.memories.local', memory:'https://stage.api.memories.local',
      access:'https://stage.api.memories.local', audit:'https://stage.api.memories.local', notification:'https://stage.api.memories.local',
      moderation:'https://stage.api.memories.local', publicView:'https://stage.api.memories.local', qrcode:'https://stage.api.memories.local' } },
    prod:{ name:'prod', gateway:'https://api.memories.app', services:{
      identity:'https://identity.memories.app', profile:'https://api.memories.app', memory:'https://api.memories.app',
      access:'https://api.memories.app', audit:'https://api.memories.app', notification:'https://api.memories.app',
      moderation:'https://moderation.memories.app', publicView:'https://public.memories.app', qrcode:'https://qrcode.memories.app' } }
  };

  let currentEnvKey = 'dev';

  function getServiceBase(service){
    const env = ENV_PRESETS[currentEnvKey];
    return (env && env.services && env.services[service]) ? env.services[service] : env.gateway;
  }

  // === URL –¥–µ–º–æ-—Ñ—Ä–æ–Ω—Ç–∞ –ø–æ ENV
  function computeDemoUrl(){
    if (currentEnvKey === 'dev') return 'http://localhost:5173/'; // Vite dev server
    const env = ENV_PRESETS[currentEnvKey];
    const base = (env?.gateway || location.origin).replace(/\/$/, '');
    return `${base}/demo/memories-demo/`; // —Å—Ç–∞—Ç–∏–∫–∞ —Å–æ–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ—Ä–æ–Ω—Ç–∞
  }
  openDemoBtn.addEventListener('click', () => {
    window.open(computeDemoUrl(), '_blank', 'noopener');
  });

  // endpoints
  const endpoints = {
    identity: {
      login: { label:'Login', method:'POST', service:'identity', path:'/identity/login', mode:'json',
        json:{ username:'andrey', password:'andrey256!' }, hint:'–í—ã–¥–∞—ë—Ç accessToken/refreshToken ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–≤—ã–º, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å JWT.' },
      register: { label:'Register', method:'POST', service:'identity', path:'/identity/register', mode:'json',
        json:{ username:'user1', password:'User1!pass', email:'u1@example.com', displayName:'User 1' }, hint:'–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.' },
      refresh: { label:'Refresh', method:'POST', service:'identity', path:'/identity/refresh', mode:'json',
        json:{ refreshToken:'<your-refresh-token>' }, hint:'–û–±–Ω–æ–≤–ª—è–µ—Ç accessToken –ø–æ refreshToken.' },
      me: { label:'Me', method:'GET', service:'identity', path:'/identity/me', mode:'none', hint:'–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Ç–æ–∫–µ–Ω—É (JWT –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω).' }
    },
    memory: {
      create: { label:'CreateMemory (multipart)', method:'POST', service:'memory', path:'/memory/api/memory', mode:'form',
        form:{ OwnerId:'fdd2eee1-7871-45da-a3b4-c6a214ef4928', Title:'Trip to Alps', Description:'Ski weekend', MediaType:'Image', AccessLevel:'Private', Tags:'alps,trip' },
        hint:'–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å —Å —Ñ–∞–π–ª–∞–º–∏ (FormData + File x N).' },
      get: { label:'GetMemoryById', method:'GET', service:'memory',
        path:'/memory/api/memory/1f6cbd66-dc14-4c35-a1f1-94928a4caa5f', mode:'none', hint:'–ü–æ–ª—É—á–∏—Ç—å –∑–∞–ø–∏—Å—å –ø–æ –µ—ë –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É.' },
      update: { label:'UpdateMemory', method:'PUT', service:'memory',
        path:'/memory/api/memory/1f6cbd66-dc14-4c35-a1f1-94928a4caa5f', mode:'json',
        json:{ title:'New title', description:'Updated', accessLevel:'Public', tags:['alps','winter'] },
        hint:'–û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏.' },
      delete: { label:'DeleteMemory', method:'DELETE', service:'memory',
        path:'/memory/api/memory/1f6cbd66-dc14-4c35-a1f1-94928a4caa5f', mode:'none', hint:'–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å.' },

      upload: { label:'UploadMedia (multipart)', method:'POST', service:'memory',
        path:'/memory/api/memory/1f6cbd66-dc14-4c35-a1f1-94928a4caa5f/media', mode:'form',
        form:{ MediaType:'Image', FileName:'pic1.jpg' }, hint:'–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª(—ã) –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞–ø–∏—Å–∏ (FormData + File x N).' },

      mediaGet: { label:'GetMediaById', method:'GET', service:'memory',
        path:'/memory/api/media/936496b7-f08a-420f-a4f7-347fe6865934', mode:'none', hint:'–ü–æ–ª—É—á–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –º–µ–¥–∏–∞ –ø–æ id.' },
      mediaUpd: { label:'UpdateMedia', method:'PUT', service:'memory',
        path:'/memory/api/memory/1f6cbd66-dc14-4c35-a1f1-94928a4caa5f/media/e913eb2c-6075-429c-8240-e265c0c00ad0', mode:'json',
        json:{ fileName:'renamed.jpg', mediaType:'Image' }, hint:'–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∏–ª–∏ —Å–º–µ–Ω–∏—Ç—å —Ç–∏–ø –º–µ–¥–∏–∞.' },
      mediaDel: { label:'DeleteMedia', method:'DELETE', service:'memory',
        path:'/memory/api/memory/1f6cbd66-dc14-4c35-a1f1-94928a4caa5f/media/e913eb2c-6075-429c-8240-e265c0c00ad0', mode:'none', hint:'–£–¥–∞–ª–∏—Ç—å –º–µ–¥–∏–∞.' },

      listUser: { label:'ListByUser', method:'GET', service:'memory',
        path:'/memory/api/memory/user/fdd2eee1-7871-45da-a3b4-c6a214ef4928?page=1&pageSize=10', mode:'none',
        hint:'–°–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π.' }
    },
    access: {
      grant: { label:'Grant', method:'POST', service:'access', path:'/access-control/api/access/grant', mode:'json',
        json:{ subjectId:'4beed3da-37f8-423b-a16b-5a0fea4bbc38', subjectType:'User', resourceType:'Memory',
               resourceId:'17e5b201-d562-4c5c-b90f-414349bca627', permission:'Edit', expiresAt:null },
        hint:'–í—ã–¥–∞—Ç—å –ø—Ä–∞–≤–æ –Ω–∞ —Ä–µ—Å—É—Ä—Å.' },
      revoke: { label:'Revoke', method:'POST', service:'access', path:'/access-control/api/access/revoke', mode:'json',
        json:{ subjectId:'4beed3da-37f8-423b-a16b-5a0fea4bbc38', subjectType:'User', resourceType:'Memory',
               resourceId:'17e5b201-d562-4c5c-b90f-414349bca627', permission:'Edit' },
        hint:'–û—Ç–æ–∑–≤–∞—Ç—å –ø—Ä–∞–≤–æ.' },
      check: { label:'Check', method:'POST', service:'access', path:'/access-control/api/access/check', mode:'json',
        json:{ subjectId:'8bfbdace-33b7-4764-9903-39a6dc48bf7d', resourceType:'Memory',
               resourceId:'17e5b201-d562-4c5c-b90f-414349bca627', permission:'Edit' },
        hint:'–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ –ø—Ä–∞–≤–æ.' },
      shares: { label:'List Shares', method:'GET', service:'access',
        path:'/access-control/api/access/memory/17e5b201-d562-4c5c-b90f-414349bca627/shares', mode:'none',
        hint:'–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –≤—ã–¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø—ã –∫ –ø–∞–º—è—Ç–∏.' }
    },
    audit: {
      create: { label:'Create', method:'POST', service:'audit', path:'/audit-logging/auditlogs', mode:'json',
        json:{ action:'Access.Revoke', target:'Memory:42', details:'revoked by admin', result:'success',
               data:'{"extra":"value"}', userId:'00000000-0000-0000-0000-000000000000',
               timestamp:new Date().toISOString(), ipAddress:'127.0.0.1', userAgent:'UnifiedAPI UI' },
        hint:'–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –∞—É–¥–∏—Ç–∞.' },
      search: { label:'Search', method:'GET', service:'audit', path:'/audit-logging/auditlogs', mode:'none', hint:'–ü–æ–∏—Å–∫ —Å–æ–±—ã—Ç–∏–π –∞—É–¥–∏—Ç–∞.' },
      getById: { label:'GetById', method:'GET', service:'audit', path:'/audit-logging/auditlogs/0cf44724-b65d-48da-a340-0c0cb653503c', mode:'none', hint:'–ü–æ–ª—É—á–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ –∞—É–¥–∏—Ç–∞ –ø–æ id.' },
      delete: { label:'Delete', method:'DELETE', service:'audit', path:'/audit-logging/auditlogs/b8b613f3-5ff5-463a-ad5c-7a5e554a7d5a', mode:'none', hint:'–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∞—É–¥–∏—Ç–∞.' }
    },
    notification: {
      notifyUser: { label:'NotifyUser', method:'POST', service:'notification', path:'/notification/api/Notification/notify', mode:'json',
        json:{ userId:'fdd2eee1-7871-45da-a3b4-c6a214ef4928', subject:'Hello!', body:'You have a new message', type:'General' },
        hint:'–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.' },
      notifyUsers: { label:'NotifyUsers', method:'POST', service:'notification', path:'/notification/api/Notification/notify-many', mode:'json',
        json:{ userIds:['fdd2eee1-7871-45da-a3b4-c6a214ef4928','00000000-0000-0000-0000-000000000124'], subject:'Maintenance', body:'System maintenance at 22:00', type:'SystemAlert' },
        hint:'–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.' },
      broadcast: { label:'Broadcast (501)', method:'POST', service:'notification', path:'/notification/api/Notification/broadcast', mode:'json',
        json:{ subject:'Global notice', body:'We are deploying a new version', type:'SystemAlert' }, hint:'–®–∏—Ä–æ–∫–æ–≤–µ—â–∞—Ç–µ–ª—å–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ (–Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ).' },
      health: { label:'Health (ready)', method:'GET', service:'notification', path:'/notification/health/ready', mode:'none', hint:'–ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞.' }
    },
    profile: {
      create: { label:'CreateProfile', method:'POST', service:'profile', path:'/profile/api/profile', mode:'json',
        json:{ userId:'00000000-0000-0000-0000-000000000003', fullName:'John Doe', birthDate:'1990-05-20T00:00:00Z',
               displayName:'JD', bio:'Hello there', accessMode:'AfterDeath', avatarUrl:null },
        hint:'–°–æ–∑–¥–∞—ë—Ç –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.' },
      getById: { label:'GetById', method:'GET', service:'profile', path:'/profile/api/profile/{id}', mode:'none', hint:'–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ id.' },
      getByUser: { label:'GetByUserId', method:'GET', service:'profile', path:'/profile/api/profile/by-user/{userId}', mode:'none', hint:'–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ userId.' },
      update: { label:'UpdateProfile', method:'PUT', service:'profile', path:'/profile/api/profile/{id}', mode:'json',
        json:{ id:'00000000-0000-0000-0000-000000000005', fullName:'Johnathan Doe', birthDate:'1990-05-20T00:00:00Z',
               displayName:'Johnny', bio:'Updated bio', accessMode:'AfterDeath', avatarUrl:null },
        hint:'–û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—è –ø—Ä–æ—Ñ–∏–ª—è.' },
      delete: { label:'DeleteProfile', method:'DELETE', service:'profile', path:'/profile/api/profile/fdd2eee1-7871-45da-a3b4-c6a214ef4928', mode:'none', hint:'–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å.' },
      confirmDeath: { label:'ConfirmDeath', method:'POST', service:'profile', path:'/profile/api/profile/fdd2eee1-7871-45da-a3b4-c6a214ef4928/confirm-death', mode:'none', hint:'–û—Ç–º–µ—Ç–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ DeathConfirmed.' }
    },
    moderation: {
      createReview: { label:'CreateReview', method:'POST', service:'moderation', path:'/moderation/api/reviews', mode:'json',
        json:{ ResourceType:'Memory', ResourceId:'00000000-0000-0000-0000-000000000010', Content:'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ä—É—à–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞' },
        hint:'–°–æ–∑–¥–∞—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é (review) –¥–ª—è —Ä–µ—Å—É—Ä—Å–∞.' },
      getReview: { label:'GetReviewById', method:'GET', service:'moderation', path:'/moderation/api/reviews/00000000-0000-0000-0000-000000000011', mode:'none',
        hint:'–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å/–¥–∞–Ω–Ω—ã–µ —Ä–µ–≤—å—é –ø–æ id.' },
      listReviews: { label:'ListReviews', method:'GET', service:'moderation', path:'/moderation/api/reviews?status=Pending&page=1&pageSize=20', mode:'none',
        hint:'–°–ø–∏—Å–æ–∫ —Ä–µ–≤—å—é (—Ñ–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É/pagination).' },
      decide: { label:'DecideReview', method:'POST', service:'moderation',
        path:'/moderation/api/reviews/00000000-0000-0000-0000-000000000011/decide', mode:'json',
        json:{ Decision:'Approve|Reject', ModeratorId:'mod-123', Reason:'–ü—Ä–∏—á–∏–Ω–∞ —Ä–µ—à–µ–Ω–∏—è' },
        hint:'–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏–µ –ø–æ —Ä–µ–≤—å—é.' }
    },
    publicView: {
      getPublicProfile: { label:'GetPublicProfile', method:'GET', service:'publicView', path:'/public/api/profile/fdd2eee1-7871-45da-a3b4-c6a214ef4928', mode:'none',
        hint:'–ü—É–±–ª–∏—á–Ω–∞—è –ø—Ä–æ–µ–∫—Ü–∏—è –ø—Ä–æ—Ñ–∏–ª—è (–±–µ–∑ JWT, –µ—Å–ª–∏ –ø—É–±–ª–∏—á–Ω–æ).' },
      getPublicMemory: { label:'GetPublicMemory', method:'GET', service:'publicView', path:'/public/api/memory/1f6cbd66-dc14-4c35-a1f1-94928a4caa5f', mode:'none',
        hint:'–ü—É–±–ª–∏—á–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–∞–º—è—Ç–∏.' }
    },
    qrcode: {
      genPng: { label:'GeneratePNG', method:'GET', service:'qrcode',
        path:'/qrcode/api/generate?url=https://public.memories.app/u/4beed3da-37f8-423b-a16b-5a0fea4bbc38', mode:'none',
        hint:'–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å PNG QR-–∫–æ–¥ (image/png).' },
      genDataUrl: { label:'GenerateDataUrl', method:'GET', service:'qrcode',
        path:'/qrcode/api/generate-dataurl?url=https://public.memories.app/u/4beed3da-37f8-423b-a16b-5a0fea4bbc38', mode:'none',
        hint:'–í–µ—Ä–Ω—É—Ç—å base64 data-url –¥–ª—è QR.' }
    }
  };

  const LS_JWT_KEY = 'memories.jwt';
  const LS_PERSIST = 'memories.persist';
  let currentTab = 'identity', currentEndpointKey = '';
  let lastMedia = []; // –∑–∞–ø–æ–º–∏–Ω–∞–µ–º –º–µ–¥–∏–∞ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ JSON-–æ—Ç–≤–µ—Ç–∞

  // Build full URL
  function buildFullUrl(p){
    const base = getServiceBase(p.service || 'gateway');
    if (p.path.startsWith('http://') || p.path.startsWith('https://')) return p.path;
    return base.replace(/\/$/, '') + p.path;
  }

  function fillMethodList(){
    method.innerHTML = '';
    ['GET','POST','PUT','DELETE'].forEach(m=>{
      const o = document.createElement('option'); o.value = m; o.textContent = m; method.appendChild(o);
    });
  }

  function fillEndpointList(tab){
    endpointSel.innerHTML = '';
    Object.entries(endpoints[tab]).forEach(([k,v])=>{
      const o = document.createElement('option'); o.value = k; o.textContent = v.label; endpointSel.appendChild(o);
    });
    currentEndpointKey = Object.keys(endpoints[tab])[0];
    endpointSel.value = currentEndpointKey;
  }

  function setMode(mode){
    const isJson = mode==='json', isForm = mode==='form';
    jsonBlock.style.display = isJson ? '' : 'none';
    formBlock.style.display = isForm ? '' : 'none';
    updateCurl();
  }

  function applyPreset(tab, key){
    const p = endpoints[tab][key]; if (!p) return;
    method.value = p.method;
    const full = buildFullUrl(p);
    url.value = full;
    urlHint.textContent = p.hint || '';
    setMode(p.mode);
    if (p.mode === 'json') {
      json.value = typeof p.json === 'string' ? p.json : JSON.stringify(p.json || {}, null, 2);
    }
    if (p.mode === 'form') {
      document.getElementById('OwnerId').value = p.form?.OwnerId ?? '';
      document.getElementById('Title').value = p.form?.Title ?? '';
      document.getElementById('Description').value = p.form?.Description ?? '';
      document.getElementById('MediaType').value = p.form?.MediaType ?? 'Image';
      document.getElementById('AccessLevel').value = p.form?.AccessLevel ?? 'Private';
      document.getElementById('Tags').value = p.form?.Tags ?? '';
      document.getElementById('FileName').value = p.form?.FileName ?? '';
      fileInput.value = ''; filePreview.textContent = '–§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã';
    }
    updateCurl();
  }

  function ph(u){
    return u
      .replace('{memoryId}','00000000-0000-0000-0000-000000000001')
      .replace('{mediaId}','00000000-0000-0000-0000-000000000002')
      .replace('{userId}','00000000-0000-0000-0000-000000000003')
      .replace('{subjectId}','00000000-0000-0000-0000-000000000004')
      .replace('{id}','00000000-0000-0000-0000-000000000005');
  }

  function escSh(s){ return s.replace(/'/g, `'\"'\"'`); }

  function buildCurl(){
    const m = method.value, u = ph(url.value);
    const token = auth.value.trim();
    const parts = [`curl -X '${m}' \\`, `  '${u}' \\`];
    if (token) parts.push(`  -H 'Authorization: Bearer ${escSh(token)}' \\`);

    if (jsonBlock.style.display !== 'none') {
      parts.push(`  -H 'Content-Type: application/json' \\`);
      if (json.value) parts.push(`  -d '${escSh(json.value)}'`);
    } else if (formBlock.style.display !== 'none') {
      const ownerId = document.getElementById('OwnerId').value;
      const title = document.getElementById('Title').value;
      const description = document.getElementById('Description').value;
      const mediaType = document.getElementById('MediaType').value;
      const accessLevel = document.getElementById('AccessLevel').value;
      const tags = document.getElementById('Tags').value;
      const fileName = document.getElementById('FileName').value;

      const toF = (k,v)=> v ? `  -F '${k}=${escSh(v)}' \\` : '';
      parts.push(toF('OwnerId', ownerId));
      parts.push(toF('Title', title));
      parts.push(toF('Description', description));
      parts.push(toF('MediaType', mediaType));
      parts.push(toF('AccessLevel', accessLevel));
      if (tags) tags.split(',').map(t=>t.trim()).filter(Boolean).forEach(t=>parts.push(`  -F 'Tags=${escSh(t)}' \\`));

      if (fileInput.files?.length) {
        for (const f of fileInput.files) {
          parts.push(`  -F 'File=@${escSh(f.name)}' \\`);
        }
      } else {
        parts.push(`  -F 'File=@<path-to-file1>' \\`);
        parts.push(`  -F 'File=@<path-to-file2>' \\`);
      }

      if (fileName) parts.push(`  -F 'FileName=${escSh(fileName)}' \\`);
      if (parts[parts.length-1].endsWith('\\')) parts[parts.length-1] = parts[parts.length-1].slice(0,-2);
    }
    return parts.filter(Boolean).join('\n');
  }

  function updateCurl(){ curlBox.value = buildCurl(); }

  async function sendRequest(){
    sendBtn.disabled = true; statusEl.textContent = '‚Ä¶';
    statusEl.className = 'pill ' + (method.value === 'GET' ? 'get' : 'post');
    preview.style.display = 'none'; previewGrid.innerHTML = ''; previewToolbar.style.display = 'none'; lastMedia = [];
    try{
      const u = ph(url.value);
      const token = auth.value.trim();
      const headers = new Headers();
      if (token) headers.set('Authorization', `Bearer ${token}`);

      let init = { method: method.value, headers };
      if (jsonBlock.style.display !== 'none') {
        headers.set('Content-Type', 'application/json');
        init.body = json.value || '';
      } else if (formBlock.style.display !== 'none') {
        const fd = new FormData();
        const ownerId = document.getElementById('OwnerId').value;
        const title = document.getElementById('Title').value;
        const description = document.getElementById('Description').value;
        const mediaType = document.getElementById('MediaType').value;
        theaccess = document.getElementById('AccessLevel').value;
        const tags = document.getElementById('Tags').value;
        const fileName = document.getElementById('FileName').value;

        if (ownerId) fd.append('OwnerId', ownerId);
        if (title) fd.append('Title', title);
        if (description) fd.append('Description', description);
        if (mediaType) fd.append('MediaType', mediaType);
        if (theaccess) fd.append('AccessLevel', theaccess);
        if (tags) tags.split(',').map(t=>t.trim()).filter(Boolean).forEach(t=>fd.append('Tags', t));

        if (fileInput.files?.length) {
          for (const f of fileInput.files) {
            fd.append('File', f, f.name || 'upload.bin'); // –ø–æ–≤—Ç–æ—Ä—è–µ–º—ã–π –∫–ª—é—á File
          }
        }
        if (fileName) fd.append('FileName', fileName);
        init.body = fd;
      }

      const res = await fetch(u, init);
      statusEl.textContent = res.status + ' ' + res.statusText;

      const hdrs = []; res.headers.forEach((v,k)=>hdrs.push(`${k}: ${v}`));
      respHeaders.value = hdrs.join('\n');

      const ct = res.headers.get('content-type') || '';
      let text;
      if (ct.includes('application/json')) {
        const j = await res.json().catch(()=> ({}));
        if (j && j.accessToken) { auth.value = j.accessToken; localStorage.setItem(LS_JWT_KEY, j.accessToken); }
        text = JSON.stringify(j, null, 2);
        tryRenderPreview(j);
      } else if (ct.startsWith('image/')) {
        const blob = await res.blob();
        const dataUrl = await new Promise((resolve)=>{
          const r = new FileReader(); r.onload = ()=>resolve(r.result); r.readAsDataURL(blob);
        });
        text = `<< binary image returned (${res.status}) >>`;
        preview.style.display = 'block'; previewToolbar.style.display = 'flex';
        previewGrid.innerHTML = `<div class="preview-item"><img src="${dataUrl}" alt="image"/><div class="meta">${res.status} ${res.statusText}</div></div>`;
      } else {
        text = await res.text();
      }
      respEl.textContent = text || '‚Äî'; hljs.highlightElement(respEl);
    } catch (e){
      statusEl.textContent = 'ERR';
      respEl.textContent = String(e); hljs.highlightElement(respEl);
    } finally {
      sendBtn.disabled = false; updateCurl();
    }
  }

  // === –°–æ–±–∏—Ä–∞–µ–º –º–µ–¥–∏–∞ —Å–æ –≤—Å–µ—Ö items[], –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ ===
  function tryRenderPreview(obj){
    let mf = [];

    if (Array.isArray(obj?.mediaFiles)) {
      mf = obj.mediaFiles;
    } else if (Array.isArray(obj?.items)) {
      for (const it of obj.items) {
        if (Array.isArray(it?.mediaFiles) && it.mediaFiles.length) {
          const withMem = it.mediaFiles.map(m => ({ ...m, _memoryId: it.id }));
          mf.push(...withMem);
        }
      }
    }

    if (!Array.isArray(mf) || !mf.length) return;

    const seen = new Set();
    mf = mf.filter(m => {
      const key = m.id || m.url;
      if (!key) return true;
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    });

    lastMedia = mf;
    preview.style.display = 'block'; previewToolbar.style.display = 'flex';
    previewGrid.innerHTML = '';

    for (const m of mf) {
      const item = document.createElement('div'); item.className = 'preview-item';
      const mt = (m.mediaType || '').toLowerCase();
      let media = '';
      if (mt.includes('image')) {
        const src = m.url || '#';
        const alt = m.fileName || m.id || 'image';
        media = `<img src="${src}" alt="${alt}" class="js-thumb" data-full="${src}"/>`;
      } else if (mt.includes('video')) {
        media = `<video src="${m.url || '#'}" controls></video>`;
      } else if (mt.includes('audio')) {
        media = `<audio src="${m.url || '#'}" controls></audio>`;
      } else {
        media = `<a href="${m.url || '#'}" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª</a>`;
      }
      const memMark = m._memoryId ? `<br class="tiny"/><span class="tiny">memoryId: ${m._memoryId}</span>` : '';
      item.innerHTML = `${media}<div class="meta">${m.fileName || ''}<br>${m.mediaType || ''}${m.id ? `<br>ID: ${m.id}`:''}${memMark}</div>`;
      previewGrid.appendChild(item);
    }
  }

  // open full image in lightbox
  previewGrid.addEventListener('click', (e)=>{
    const img = e.target.closest('img.js-thumb');
    if (!img) return;
    const full = img.dataset.full || img.src;
    openLightbox(full, img.alt || '');
  });

  // Toolbar actions
  openAllBtn.addEventListener('click', ()=>{
    if (!lastMedia.length) return;
    for (const m of lastMedia) { if (m.url) window.open(m.url, '_blank', 'noopener'); }
  });

  copyIdsBtn.addEventListener('click', async ()=>{
    const ids = lastMedia.map(m=>m.id).filter(Boolean);
    if (!ids.length) return;
    await navigator.clipboard.writeText(ids.join('\n'));
  });

  downloadAllBtn.addEventListener('click', async ()=>{
    if (!lastMedia.length) return;
    dlHint.style.display = 'inline'; dlHint.textContent = '–°–æ–±–∏—Ä–∞—é zip‚Ä¶';
    try{
      const zip = new JSZip();
      let idx = 0;
      for (const m of lastMedia){
        if (!m.url) continue;
        const name = (m.fileName && m.fileName.trim()) ? m.fileName : `file_${++idx}`;
        const resp = await fetch(m.url);
        const blob = await resp.blob();
        zip.file(name, blob);
      }
      const content = await zip.generateAsync({type:'blob'});
      saveAs(content, `media_${Date.now()}.zip`);
    } catch(e){
      console.error(e);
    } finally {
      dlHint.style.display = 'none';
      dlHint.textContent = '';
    }
  });

  // events
  sendBtn.addEventListener('click', sendRequest);
  fillBtn.addEventListener('click', ()=>applyPreset(currentTab, currentEndpointKey));
  endpointSel.addEventListener('change', ()=>{ currentEndpointKey = endpointSel.value; applyPreset(currentTab, currentEndpointKey); });
  tabs.addEventListener('click', e=>{
    const b = e.target.closest('[data-tab]'); if (!b) return;
    [...tabs.children].forEach(x=>x.classList.toggle('active', x===b));
    currentTab = b.dataset.tab; fillEndpointList(currentTab); applyPreset(currentTab, Object.keys(endpoints[currentTab])[0]);
  });
  ['change','input'].forEach(ev=>{
    method.addEventListener(ev, updateCurl); url.addEventListener(ev, updateCurl);
    auth.addEventListener(ev, updateCurl); json.addEventListener(ev, updateCurl);
  });

  document.getElementById('copyJwt').addEventListener('click', ()=>navigator.clipboard.writeText(auth.value || ''));
  document.getElementById('copyCurl').addEventListener('click', ()=>navigator.clipboard.writeText(curlBox.value || ''));
  persistBodies.addEventListener('change', ()=>localStorage.setItem(LS_PERSIST, persistBodies.checked ? '1' : '0'));

  fileInput.addEventListener('change', ()=>{
    if (fileInput.files?.length) {
      const items = [...fileInput.files].map(f => `${f.name} (${f.type || 'binary'}, ${f.size} bytes)`);
      filePreview.textContent = `${fileInput.files.length} —Ñ–∞–π–ª(–æ–≤):\n- ` + items.join('\n- ');
    } else {
      filePreview.textContent = '–§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã';
    }
    updateCurl();
  });

  // ENV change
  envSelect.addEventListener('change', ()=>{
    currentEnvKey = envSelect.value;
    const env = ENV_PRESETS[currentEnvKey];
    gatewayDisplay.textContent = env.gateway;
    applyPreset(currentTab, currentEndpointKey);
  });

  // Quick Login
  quickLoginBtn.addEventListener('click', async ()=>{
    const targetTabBtn = [...tabs.children].find(b=>b.dataset.tab==='identity');
    if (targetTabBtn) targetTabBtn.click();
    currentEndpointKey = 'login';
    endpointSel.value = 'login';
    applyPreset('identity','login');
    try { await sendRequest(); } catch(e){ console.error(e); }
  });

  // init
  (function init(){
    const savedJwt = localStorage.getItem(LS_JWT_KEY); if (savedJwt) auth.value = savedJwt;
    persistBodies.checked = (localStorage.getItem(LS_PERSIST) === '1');
    fillMethodList();
    envSelect.value = currentEnvKey;
    gatewayDisplay.textContent = ENV_PRESETS[currentEnvKey].gateway;
    currentTab = 'identity';
    fillEndpointList('identity');
    endpointSel.value = 'login'; currentEndpointKey = 'login';
    applyPreset('identity','login');
    [...tabs.children].forEach(x=>x.classList.toggle('active', x.dataset.tab === 'identity'));
  })();
})();
</script>
</body>
</html>
